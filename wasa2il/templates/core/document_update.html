{% extends "base.html" %}
{% load i18n %}



{% block javascript %}
{{block.super}}
    <script src="/static/js/document.js"></script>
	<script>
		var DOCUMENT_ID = {{document.id}};
		var PROPOSED = {% if document.is_proposed %}true{% else %}false{% endif %};
		var selected_item = undefined;
	</script>
{% endblock %}



{% block content %}

<div class="btn-group pull-right">
	{% if document.user == user %}
		{% if document.is_proposed %}
			<a class="btn" onclick="document_propose({{document.id}}, 0);">{% trans "Withdraw proposal" %}</a>
		{% else %}
			<a class="btn" onclick="document_propose({{document.id}}, 1);">{% trans "Propose this document" %}</a>
		{% endif %}
	{% endif %}
</div>

<h1>
	<small>
		{% if document.is_adopted %}
			{% trans "Agreement" %} {{document.decid}}
		{% elif document.is_proposed %}
			{% trans "Proposal" %} {{document.id}}
		{% else %}
			{% trans "Draft proposal"%}
		{% endif %}:
	</small>
	{{document.name}}
</h1>

<div class="row">

	<div class="span6 pull-left document">

		<p><b>{{document.name}}</b></p>

		{% if document.polity.document_frontmatter %}
		<p class="document-fragment"><i>{{document.polity.document_frontmatter}}</i></p>
		{% endif %}

		{% with statementset_name='references' statementset=document.get_references %}
			{% include 'core/_document_statementset.html' %}
		{% endwith %}

		{% with statementset_name='assumptions' statementset=document.get_assumptions %}
			{% include 'core/_document_statementset.html' %}
		{% endwith %}

		{% if document.polity.document_midmatter %}
		<p class="document-fragment">{{document.polity.document_midmatter}}</p>
		{% endif %}

		{% with statementset_name='declarations' statementset=document.get_declarations %}
			{% include 'core/_document_statementset.html' %}
		{% endwith %}

		{% if document.polity.document_footer %}
		<p class="document-fragment">{{document.polity.document_footer}}</p>
		{% endif %}

	</div>

	<div class="span4 pull-right">

		{% if document.issues.count %}
		<h3>{% trans "Referenced by issues" %}</h3>
		<ul>
		{% for i in document.issues.all %}
			<li><a href="/issue/{{i.id}}/">{{i.name}}</a></li>
		{% endfor %}
		</ul>
		{% endif %}

		<h3>{% trans "Contributors to this document" %}</h3>
		<ul>
		{% for i in document.get_contributors %}
			<li><a href="/accounts/profile/{{i.username}}">{{i.username}}</a></li>
		{% endfor %}
		</ul>

		{% if not document.is_proposed %}
		<form class="form-inline" action="#">
			<input type="text" class="input-small" id="meeting_manager_add" data-polity-id="{{polity.id}}"/>
			<input type="submit" class="btn btn-small" id="meeting_manager_add_btn" value="{% trans "Add" %}"/>
		</form>
		{% endif %}

	</div>

	{% if document.polity in user.polity_set.all %}
	<div class="span2 pull-right">

		{% if not document.is_proposed and not document.is_adopted %}
		<div class="btn-group btn-group-vertical">
			<a onclick="$('#modal_reference').modal('show');" class="btn">{% trans "New reference" %}</a>
			<a onclick="$('#modal_assumption').modal('show');" class="btn">{% trans "New assumption" %}</a>
			<a onclick="$('#modal_declaration').modal('show');" class="btn">{% trans "New statement" %}</a>
			<a onclick="$('#modal_subheading').modal('show');" class="btn">{% trans "New subheading" %}</a>
			<a onclick="$('#modal_import').modal('show');" class="btn">{% trans "Import structure" %}</a>
		</div>
		{% elif document.is_proposed %}
		<div class="alert alert-success">
			<b>{% trans "Please note:" %}</b>
			{% trans "This document has been proposed." %}
			{% trans "Changes you make to it now will become change proposals, which will be voted on individually." %}
		</div>
		{% elif document.is_adopted and not document.is_proposed %}
		<div class="alert alert-success">
			<b>{% trans "Please note:" %}</b>
			{% trans "This document has been adopted." %}
			{% trans "In order to make change proposals to it, you must import it into a new open issue." %}
		</div>
		{% endif %}

	</div>
	{% endif %}

</div>

<div class="row" id="changeproposals">
	<div class="span8">
		<h3>{% trans "Change proposals" %}</h3>
		<table class="table table-striped">
		{% for cp in document.changeproposal_set.all %}
			<tr>
				{% if cp.actiontype == 1 %}
				<td>{{cp.getref}}</td><td>[{% trans "Deleted" %}]</td>
				{% endif %}
				{% if cp.actiontype == 2 %}
				<td>{{cp.getref}}</td><td>[{% trans "Moved" %}]</td>
				{% endif %}
				{% if cp.actiontype == 3 %}
				<td>{{cp.getref}}</td><td>{{cp.content}}</td>
				{% endif %}
				{% if cp.actiontype == 4 %}
				<td>{% if cp.refitem == 0 %}
					{% trans "Added at beginning" %}
					{% else %}
					{% trans "Added after:" %}
					{{cp.get_refitem}}
					{% endif %}
				</td>
				<td>{{cp.content}}</td>
				{% endif %}
			</tr>
		{% endfor %}
		</table>
	</div>
</div>

{% with type_name='reference' %}
	{% include 'core/_document_modal.html' %}
{% endwith %}

{% with type_name='assumption' %}
	{% include 'core/_document_modal.html' %}
{% endwith %}

{% with type_name='statement' %}
	{% include 'core/_document_modal.html' %}
{% endwith %}

{% with type_name='subheading' %}
	{% include 'core/_document_modal.html' %}
{% endwith %}

{% with type_name='import' %}
	{% include 'core/_document_modal.html' %}
{% endwith %}

{% endblock %}
