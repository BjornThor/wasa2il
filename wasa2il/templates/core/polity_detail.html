{% extends "base.html" %}
{% load i18n %}
{% load wasa2il %}
{% block content %}

<div style="float:right;" class="btn-group">
{% if user_is_member %}
  <a class="btn" href="/polity/{{polity.id}}/leave/">{% trans "Leave polity" %}</a>
{% endif %}
{% if not user_is_member and not user_requested_membership %}
<a class="btn" href="/polity/{{polity.id}}/join/">{% trans "Join polity" %}</a>
	{% if polity.invite_threshold == 0 %}
	<a class="btn" href="/polity/{{polity.id}}/join/">{% trans "Request to join polity" %}</a>
	{% endif %}
{% endif %}
</div>
<h1>{{polity.name}}</h1>

{% if user_requested_membership %}
	{% if user_requested_membership_now %}
		<div class="alert alert-success">{% trans "Your request to join has been sent." %}</div>
	{% else %}
		<div class="alert alert-success">{% trans "Your request to join this polity is still pending." %}</div>
	{% endif %}
{% endif %}

<div id="polity_stats" class="subnav">
	<ul class="nav nav-pills">
		<li><a href="#" onclick="$('#modal_members').modal('show');">{{polity.members.count}} {% trans "members" %}</a></li>
		<li><a href="#topics">{{polity.topic_set.count}} {% trans "topics" %}</a></li>
		<li><a href="#documents">{{polity.document_set.count}} {% trans "documents" %}</a></li>
		<li><a href="#subpolities">{{polity.polity_set.count}} {% trans "subpolities" %}</a></li>
	
	{% if user_is_member %}
		{% if polity.invite_threshold > 0 %}
			{% if membership_requests.count == 0 %}
			<li class="disabled"><a href="#">{{membership_requests.count}} {% trans "membership requests" %}</a></li>
			{% else %}
			<li><a href="#" onclick="$('#modal_requests').modal('show');">{{membership_requests.count}} {% trans "membership requests" %}</a></li>
			{% endif %}
		{% endif %}
	{% endif %}	
	</ul>
</div>

<div class="row">


<div class="span6"><a name="topics"></a>
	<div class="btn-group" style="float: right">
		<a class="btn btn-mini dropdown-toggle" data-toggle="dropdown" href="#"><i class="icon-list"></i><span class="caret"></span></a>
		<ul class="dropdown-menu" style="left: -150px;">
			<li><a id="topics_showstarred_toggle" onclick="topics_showstarred_toggle({{polity.id}});"><i class="icon-ok {% if user.get_profile.topics_showall %}icon-grey{% endif %}"></i> {% trans "Show only starred topics" %}</a></li>
			<li><a href="/polity/{{polity.id}}/topic/new/">{% trans "New topic" %}</a></li>

		</ul>
	</div>
	<h2>{% trans "Topics" %} <small>{% trans "of discussion"%}</small></h2>

	<p class="muted">{% trans "Topics are thematic categories that contain specific issues." %}</p>

	<table class="table table-striped table-bordered table-condensed" id="topics_list">
	<thead>
	<tr>
		<th>{% trans "Topics" %}</th>
		<th>{% trans "Issues" %}</th>
		<th>{% trans "Open Issues" %}</th>
		<th>{% trans "Voting Issues" %}</th>
	</tr>
	</thead>
	<tbody>
	{% with politytopics as topics %}
	{% include "core/_topic_list_table.html" %}
	{% endwith %}
	</tbody>
	</table>
</div>


<div class="span6"><a name="documents"></a>
	<div class="btn-group" style="float: right">
		<a class="btn btn-mini dropdown-toggle" data-toggle="dropdown" href="#"><i class="icon-list"></i><span class="caret"></span></a>
		<ul class="dropdown-menu" style="left: -150px;">
			<li><a href="/polity/{{polity.id}}/document/new/">{% trans "New document" %}</a></li>

		</ul>
	</div>
	<h2>{% trans "Documents" %} <small>{% trans "proposed or in progress" %}</small></h2>
	
	<p class="muted">{% trans "Documents are structured texts which contain the laws of the polity, or proposals for such laws." %}</p>

	{% with polity.document_set.all as documents %}
	{% include "core/_document_list_table.html" %}
	{% endwith %}
</div>


{% if polity.polity_set.all %}
<div class="span6"><a name="subpolities"></a>
	<h2>{% trans "Subpolities" %}</h2>

	<p class="muted">{% trans "A polity can have subordinate organizational units, such as how a municipality relates to a country." %}</p>

	<ul>
	{% for subpolity in polity.polity_set.all %}
		<li><a href="/polity/{{subpolity.id}}/">{{subpolity.name}}</a></li>
	{% endfor %}
	</ul>
</div>
{% endif %}

<div class="span6"><a name="meetings"></a>
	<div class="btn-group" style="float: right">
		<a class="btn btn-mini dropdown-toggle" data-toggle="dropdown" href="#"><i class="icon-list"></i><span class="caret"></span></a>
		<ul class="dropdown-menu" style="left: -150px;" id="meetings-menu">
			<li><a href="/polity/{{polity.id}}/meeting/new/">{% trans "New meeting" %}</a></li>
			<li><a onclick="meetings_ongoing_toggle();"><i class="icon-ok"></i> {% trans "Show ongoing meetings" %}</a></li>
			<li><a onclick="meetings_upcoming_toggle();"><i class="icon-ok"></i> {% trans "Show upcoming meetings" %}</a></li>
			<li><a href="#"><i class="icon-ok icon-white"></i> {% trans "Show finished meetings" %}</a></li>
		</ul>
	</div>
	<h2>{% trans "Meetings" %} <small>{% trans "physical or virtual" %}</small></h2>

	<p class="muted">{% trans "A meeting is an event where people come together to discuss a set of agenda items." %}</p>

	<table class="table table-striped table-bordered table-condensed">
	<tr>
		<th>{% trans "When" %}</th>
		<th>{% trans "Where" %}</th>
		<th>{% trans "Organized by" %}</th>
		<th>{% trans "Status" %}</th>
	</tr>
	{% for meeting in polity.meetings_ongoing %}
	<tr>
		<td>{{meeting.time_starts|date:"d/M/Y h:i"}}</td>
		<td>{{meeting.where}}</td>
		<td>{{meeting.get_managers}}</td>
		<td>{{meeting.get_status}}</td>
	</tr>	
	{% endfor %}
	{% for meeting in polity.meetings_upcoming %}
	<tr>
		<td><a href="/polity/{{meeting.polity.id}}/meeting/{{meeting.id}}/">{{meeting.time_starts|date:"d/M/Y h:i"}}</td>
		<td>{{meeting.where}}</td>
		<td>{% for man in meeting.managers.all %}<a href="/accounts/profile/{{man.username}}">{{man.username}}</a>{% endfor %}</td>
		<td>{{meeting.get_status}}</td>
	</tr>	
	{% endfor %}
	</table>
</div>

</div>


<div class="modal hide fade" id="modal_members">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
    <h3>{% trans "Members of this polity" %}</h3>
  </div>
  <div class="modal-body" id="modal_members_list">

	{% for m in polity.members.all %}
		<a href="/accounts/profile/{{m.username}}/" class="thumbnail" style="background: url('/static/img/blank-user-icon.jpg') no-repeat">
			{{m.username}}
		</a>
	{% endfor %}

  </div>
  <div class="modal-footer">
    <a onclick="$('#modal_members').modal('hide');" class="btn btn-primary">{% trans "Close" %}</a>
  </div>
</div>


<div class="modal hide fade" id="modal_requests">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
    <h3>{% trans "Users requesting membership" %}</h3>
  </div>
  <div class="modal-body">

  	<ul class="nobullets">
	{% for m in membership_requests %}
		<li>
			<a
				class="thumbnail member membership_request"
				href="#"
				data-id="{{m.id}}"
				data-csrftoken="{{csrf_token}}">
	            <img src="/static/img/blank-user-icon.jpg" />
	            <div class="title">
	                <div class="title">{{m.requestor.username}}</div>
	                <div class="progress">
						<div class="membershiprequest_percent bar bar-success" style="width: {{m.votespercent}}%;">
							{{m.votes}}/{{m.votesneeded}}
						</div>
					</div>
	            </div>
	        </a>
    	</li>
	{% endfor %}
	</ul>

  </div>
  <div class="modal-footer">
    <a onclick="$('#modal_requests').modal('hide');" class="btn btn-primary">{% trans "Close" %}</a>
  </div>
</div>

<script>
$('#meetings-menu').click(function(event){
     event.stopPropagation();
});â€‹
</script>

{% endblock %}
